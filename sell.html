<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>বই বিক্রি করুন - DPI Boi Baz</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="manifest" href="manifest.json">
    <style>
        body { 
            font-family: 'Arial', sans-serif; 
            background: radial-gradient(circle, rgba(224, 60, 49, 0.1) 20%, rgba(0, 103, 71, 0.1) 100%);
            min-height: 100vh; margin: 0; display: flex; justify-content: center; align-items: center; padding: 20px;
        }
        .sell-card {
            background: white; padding: 30px; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 450px; text-align: center;
        }
        h2 { color: #006747; margin-bottom: 20px; }
        .user-info { background: #f0fdf4; padding: 10px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #dcfce7; }
        .user-info p { margin: 5px 0; font-size: 14px; color: #166534; font-weight: bold; }
        select, input { 
            width: 100%; padding: 12px; margin: 10px 0; border: 1.5px solid #eee; 
            border-radius: 10px; box-sizing: border-box; outline: none; font-size: 16px;
        }
        input:focus { border-color: #006747; }
        .btn-submit { 
            width: 100%; background: #E03C31; color: white; border: none; padding: 15px; 
            border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.3s;
        }
        .btn-submit:hover { background: #c0342a; transform: translateY(-2px); }
        #statusModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(8px); justify-content: center; align-items: center; z-index: 1000; }
        .modal-box { background: white; padding: 30px; border-radius: 20px; text-align: center; width: 85%; max-width: 320px; }
        .zoom-in { animation: zoom 0.3s ease-out; }
        @keyframes zoom { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .swipe-up { animation: swipe 0.5s forwards; }
        @keyframes swipe { to { transform: translateY(-100vh); opacity: 0; } }
    </style>
</head>
<body>

    <div class="sell-card" id="sellBox">
        <h2>বই বিক্রির ফরম</h2>
        
        <div class="user-info">
            <p id="displayUser">বিক্রেতা: লোড হচ্ছে...</p>
            <p id="displayPhone">ফোন: লোড হচ্ছে...</p>
        </div>

        <input type="text" id="bookName" placeholder="বইয়ের নাম লিখুন" required>
        <input type="text" id="publisher" placeholder="পাবলিকেশন (যেমন: হক, টেকনিক্যাল)" required>
        
        <select id="semester" required>
            <option value="" disabled selected>সেমিস্টার নির্বাচন করুন</option>
            <option value="১ম">১ম সেমিস্টার</option>
            <option value="২য়">২য় সেমিস্টার</option>
            <option value="৩য়">৩য় সেমিস্টার</option>
            <option value="৪র্থ">৪র্থ সেমিস্টার</option>
            <option value="৫ম">৫ম সেমিস্টার</option>
            <option value="৬ষ্ঠ">৬ষ্ঠ সেমিস্টার</option>
            <option value="৭ম">৭ম সেমিস্টার</option>
            <option value="৮ম">৮ম সেমিস্টার</option>
        </select>

        <select id="technology" required>
            <option value="">টেকনোলজি নির্বাচন করুন</option>
            <option value="Architecture">Architecture</option>
            <option value="Automobile">Automobile</option>
            <option value="Chemical">Chemical</option>
            <option value="Civil">Civil</option>
            <option value="Civil (Wood)">Civil (Wood)</option>
            <option value="Computer">Computer</option>
            <option value="Electrical">Electrical</option>
            <option value="Electronics">Electronics</option>
            <option value="Environmental">Environmental</option>
            <option value="Food">Food</option>
            <option value="Mechanical">Mechanical</option>
            <option value="Power">Power</option>
            <option value="Refrigeration and Air Conditioning">RAC</option>
        </select>

        <button class="btn-submit" onclick="submitBook()">বিক্রি নিশ্চিত করুন</button>
        <br><br>
        <a href="index.html" style="text-decoration:none; color:#006747; font-size:14px; font-weight:bold;">← ফিরে যান</a>
    </div>

    <div id="statusModal">
        <div class="modal-box" id="modalBox">
            <div id="modalIcon" style="font-size: 50px; margin-bottom: 10px;"></div>
            <div id="modalText" style="font-size: 18px; font-weight: bold; color: #333;"></div>
            <button id="modalOkBtn" class="btn-submit" style="margin-top: 20px; font-size:15px; padding:10px;" onclick="closeStatusModal()">ঠিক আছে</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // নতুন ডাটাবেজ কনফিগারেশন (Boi Baz v2)
        const firebaseConfig = {
          apiKey: "AIzaSyDbtD45rBSZN5RUXCHijFiabZ0uKPYeya0",
            authDomain: "boi-baz.firebaseapp.com",
            projectId: "boi-baz",
            storageBucket: "boi-baz.firebasestorage.app",
            messagingSenderId: "590447599233",
            appId: "1:590447599233:web:c969d315d5d4f2b3f87780"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const userId = localStorage.getItem('userId');
        let currentUserName = "";
        let currentUserPhone = "";

        if (!userId) { window.location.href = "login.html"; }

        // রিয়েল-টাইম প্রোফাইল ডাটা সিঙ্ক
        onSnapshot(doc(db, "users", userId), (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                currentUserName = data.name;
                currentUserPhone = data.phone;
                document.getElementById('displayUser').innerText = `বিক্রেতা: ${data.name}`;
                document.getElementById('displayPhone').innerText = `ফোন: ${data.phone}`;
            } else {
                localStorage.clear();
                window.location.href = "login.html";
            }
        });

        window.submitBook = async () => {
            const bookName = document.getElementById('bookName').value.trim();
            const publisher = document.getElementById('publisher').value.trim();
            const semester = document.getElementById('semester').value;
            const technology = document.getElementById('technology').value;

            if (!bookName || !publisher || !semester || !technology) {
                showStatus("⚠️", "সবগুলো ঘর সঠিকভাবে পূরণ করুন।", true);
                return;
            }

            showStatus("⏳", "তথ্য জমা হচ্ছে...", false);

            try {
                await addDoc(collection(db, "books"), {
                    userId: userId,
                    sellerName: currentUserName,
                    phone: currentUserPhone,
                    bookName: bookName,
                    publisher: publisher,
                    semester: semester,
                    technology: technology,
                    time: serverTimestamp() // এখানে serverTimestamp ব্যবহার করা ভালো
                });

                showStatus("✅", "বই বিক্রির আবেদন সফল হয়েছে!", false);
                setTimeout(() => {
                    document.getElementById('sellBox').classList.add('swipe-up');
                    setTimeout(() => { window.location.href = "index.html"; }, 500);
                }, 1500);

            } catch (error) {
                console.error("Error adding book: ", error);
                showStatus("❌", "সার্ভারে সমস্যা হয়েছে!", true);
            }
        };

        function showStatus(icon, msg, btnShow) {
            document.getElementById('modalIcon').innerText = icon;
            document.getElementById('modalText').innerText = msg;
            document.getElementById('modalOkBtn').style.display = btnShow ? "inline-block" : "none";
            document.getElementById('statusModal').style.display = 'flex';
            document.getElementById('modalBox').className = "modal-box zoom-in";
        }

        window.closeStatusModal = () => { document.getElementById('statusModal').style.display = 'none'; }
    </script>
</body>

</html>
