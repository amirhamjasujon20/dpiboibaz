<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ - DPI Boi Baz</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root { --primary: #006747; --white: #ffffff; --call: #28a745; --danger: #d9534f; --edit-bg: #f8f9fa; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f0f2f5; margin: 0; padding: 15px; }
        
        /* ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶ì ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
        .header-container { display: flex; justify-content: space-between; align-items: center; max-width: 600px; margin: 0 auto 20px; gap: 10px; }
        .circle { min-width: 65px; height: 65px; background: var(--primary); color: white; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 16px; font-weight: bold; }
        .circle span { font-size: 9px; font-weight: normal; }
        .search-box { flex-grow: 1; }
        .search-box input { width: 100%; padding: 10px 15px; border-radius: 25px; border: 2px solid var(--primary); outline: none; font-size: 15px; box-sizing: border-box; }

        .list-container { max-width: 600px; margin: 0 auto; }
        .user-card { background: var(--white); padding: 12px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 4px solid var(--primary); cursor: pointer; }
        .user-info h4 { margin: 0; color: #222; font-size: 16px; }
        .user-info p { margin: 2px 0 0; color: #666; font-size: 13px; }
        .call-btn { background: var(--call); color: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }

        /* ‡¶è‡¶°‡¶ø‡¶ü ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ Overlay */
        #editOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; overflow-y: auto; padding: 20px 10px; box-sizing: border-box; }
        .edit-box { background: white; width: 100%; max-width: 480px; margin: 0 auto; border-radius: 15px; padding: 20px; position: relative; }
        
        .form-row { margin-bottom: 12px; position: relative; }
        .form-row label { display: block; font-size: 13px; font-weight: bold; color: #555; margin-bottom: 4px; }
        .input-group { display: flex; align-items: center; gap: 8px; }
        .form-row input { flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: var(--edit-bg); }
        .form-row input:not([readonly]) { background: white; border-color: var(--primary); }
        .edit-icon { color: var(--primary); cursor: pointer; font-size: 16px; padding: 5px; }

        /* ‡¶¨‡¶á‡ßü‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶è‡¶°‡¶ø‡¶ü */
        .book-section { margin-top: 20px; border-top: 2px solid #f0f0f0; padding-top: 15px; }
        .book-item-edit { background: #f9f9f9; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #eee; }
        .book-inputs { display: flex; flex-direction: column; gap: 5px; margin-top: 5px; }
        .book-inputs input { padding: 8px; font-size: 13px; border: 1px solid #ccc; border-radius: 4px; background: var(--edit-bg); }
        .book-inputs input:not([readonly]) { background: white; }
        .book-header { display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 14px; color: var(--primary); }

        .action-btns { display: flex; gap: 10px; margin-top: 20px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-update { background: var(--primary); color: white; }
        .btn-close { background: #6c757d; color: white; }
    </style>
</head>
<body>

    <div class="header-container">
        <div class="circle"><div id="totalUsers">0</div><span>‡¶á‡¶â‡¶ú‡¶æ‡¶∞</span></div>
        <div class="search-box">
            <input type="number" id="phoneSearch" placeholder="‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡ßü‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." oninput="filterUsers()">
        </div>
        <div class="circle"><div id="totalBooks">0</div><span>‡¶Æ‡ßã‡¶ü ‡¶¨‡¶á</span></div>
    </div>

    <div class="list-container" id="userList">
        <p style="text-align: center; color: #888;">‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
    </div>

    <div id="editOverlay">
        <div class="edit-box">
            <h3 style="color:var(--primary); border-bottom:1px solid #eee; padding-bottom:10px; margin-top:0;">‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶â‡¶á‡¶®‡ßç‡¶°‡ßã</h3>
            
            <div class="form-row">
                <label>‡¶®‡¶æ‡¶Æ :</label>
                <div class="input-group">
                    <input type="text" id="en" readonly>
                    <i class="fas fa-pen-to-square edit-icon" onclick="enableInput('en')"></i>
                </div>
            </div>
            <div class="form-row">
                <label>‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ :</label>
                <div class="input-group">
                    <input type="text" id="ep" readonly>
                    <i class="fas fa-pen-to-square edit-icon" onclick="enableInput('ep')"></i>
                </div>
            </div>
            <div class="form-row">
                <label>‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° (pass) :</label>
                <div class="input-group">
                    <input type="text" id="eps" readonly>
                    <i class="fas fa-pen-to-square edit-icon" onclick="enableInput('eps')"></i>
                </div>
            </div>

            <div class="book-section">
                <h4 style="margin:0 0 10px 0; font-size:15px;">‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶¨‡¶á‡¶∏‡¶Æ‡ßÇ‡¶π (‡¶è‡¶°‡¶ø‡¶ü ‡¶ì ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü):</h4>
                <div id="ebl">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
            </div>

            <div class="action-btns">
                <button class="btn btn-close" onclick="closeEdit()">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                <button class="btn btn-update" onclick="applyUpdate()">‡¶∏‡¶¨ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc, getDocs, query, where, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶§‡ßÅ‡¶® ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶ú ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶®
        const firebaseConfig = {
            apiKey: "AIzaSyD_7v6rBHjVLHVK5OGiJpkgBzAuaJO8vn0",
            authDomain: "boi-baz-v2.firebaseapp.com",
            projectId: "boi-baz-v2",
            storageBucket: "boi-baz-v2.firebasestorage.app",
            messagingSenderId: "573343324145",
            appId: "1:573343324145:web:42899dd75501af36985650",
            measurementId: "G-75YZQFQ0TT"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let uArr = [];
        let curId = ""; 
        let oldPh = "";
        let bookDataList = [];

        onSnapshot(collection(db, "users"), (s) => {
            uArr = s.docs.map(d => ({ id: d.id, ...d.data() }));
            document.getElementById('totalUsers').innerText = s.size;
            drawUsers(uArr);
        });

        onSnapshot(collection(db, "books"), (s) => {
            document.getElementById('totalBooks').innerText = s.size;
        });

        function drawUsers(data) {
            const div = document.getElementById('userList');
            div.innerHTML = data.map(u => `
                <div class="user-card" onclick="openEdit('${u.id}', '${u.name}', '${u.phone}', '${u.pass}')">
                    <div class="user-info">
                        <h4>${u.name || '‡¶®‡¶æ‡¶Æ ‡¶®‡ßá‡¶á'}</h4>
                        <p>üìû ${u.phone}</p>
                    </div>
                    <div class="call-btn" onclick="event.stopPropagation(); window.location.href='tel:${u.phone}'">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="white"><path d="M6.62 10.79a15.053 15.053 0 006.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg>
                    </div>

                </div>
            `).join('');
        }

        window.enableInput = (id) => {
            const el = document.getElementById(id);
            el.readOnly = false;
            el.focus();
        };

        window.openEdit = async function(id, n, p, ps) {
            curId = id;
            oldPh = p;
            ['en', 'ep', 'eps'].forEach(i => document.getElementById(i).readOnly = true);
            document.getElementById('en').value = n || "";
            document.getElementById('ep').value = p || "";
            document.getElementById('eps').value = ps || "";
            document.getElementById('editOverlay').style.display = 'block';
            loadUserBooks(p);
        }

        async function loadUserBooks(ph) {
            const bDiv = document.getElementById('ebl');
            bDiv.innerHTML = "‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
            try {
                const q = query(collection(db, "books"), where("phone", "==", ph));
                const s = await getDocs(q);
                bookDataList = s.docs.map(d => ({ id: d.id, ...d.data() }));
                
                if(bookDataList.length === 0) { bDiv.innerHTML = "‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡¶á ‡¶®‡ßá‡¶á‡•§"; return; }
                
                bDiv.innerHTML = bookDataList.map((b, idx) => `
                    <div class="book-item-edit">
                        <div class="book-header">
                            <span>‡¶¨‡¶á #${idx+1}</span>
                            <i class="fas fa-trash-can" style="color:var(--danger); cursor:pointer;" onclick="delB('${b.id}', '${ph}')"></i>
                        </div>
                        <div class="book-inputs">
                            <div style="display:flex; align-items:center; gap:5px;">
                                <input type="text" id="bn-${b.id}" value="${b.bookName}" readonly placeholder="‡¶¨‡¶á‡ßü‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ">
                                <i class="fas fa-pen edit-icon" style="font-size:12px;" onclick="document.getElementById('bn-${b.id}').readOnly=false"></i>
                            </div>
                            <div style="display:flex; align-items:center; gap:5px;">
                                <input type="text" id="bp-${b.id}" value="${b.publisher}" readonly placeholder="‡¶™‡¶æ‡¶¨‡¶≤‡¶ø‡¶ï‡ßá‡¶∂‡¶®">
                                <i class="fas fa-pen edit-icon" style="font-size:12px;" onclick="document.getElementById('bp-${b.id}').readOnly=false"></i>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch(e) { bDiv.innerHTML = "‡¶≤‡ßã‡¶° ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•‡•§"; }
        }

        window.applyUpdate = async function() {
            const nN = document.getElementById('en').value;
            const nP = document.getElementById('ep').value;
            const nPs = document.getElementById('eps').value;

            try {
                const batch = writeBatch(db);
                // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
                batch.update(doc(db, "users", curId), { name: nN, phone: nP, pass: nPs });

                // ‡¶¨‡¶á‡ßü‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
                for (let b of bookDataList) {
                    const updatedName = document.getElementById(`bn-${b.id}`).value;
                    const updatedPub = document.getElementById(`bp-${b.id}`).value;
                    batch.update(doc(db, "books", b.id), { 
                        bookName: updatedName, 
                        publisher: updatedPub,
                        phone: nP, 
                        sellerName: nN 
                    });
                }

                await batch.commit();
                alert("‡¶∏‡¶¨ ‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
                closeEdit();
            } catch(e) { alert("‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•: " + e.message); }
        }

        window.closeEdit = () => { document.getElementById('editOverlay').style.display = 'none'; }
        
        window.delB = async (bid, ph) => {
            if(confirm("‡¶¨‡¶á‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶¨‡ßá‡¶®?")) {
                await deleteDoc(doc(db, "books", bid));
                loadUserBooks(ph);
            }
        }

        window.filterUsers = () => {
            const v = document.getElementById('phoneSearch').value;
            drawUsers(uArr.filter(u => u.phone.includes(v)));
        }
    </script>
</body>
</html>