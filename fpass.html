<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>পাসওয়ার্ড পুনরুদ্ধার - DPI Boi Baz</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Arial', sans-serif; background: #f4f7f6; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 350px; text-align: center; }
        h2 { color: #006747; margin-bottom: 20px; }
        .step { display: none; }
        .step.active { display: block; }
        .phone-container { display: flex; align-items: center; border: 1px solid #ccc; border-radius: 8px; overflow: hidden; margin-bottom: 15px; }
        .prefix { background: #eee; padding: 12px; font-weight: bold; border-right: 1px solid #ccc; }
        input { border: none; padding: 12px; width: 100%; outline: none; font-size: 16px; }
        .btn { width: 100%; background: #006747; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>

<div class="card">
    <h2>DPI Boi Baz</h2>

    <div id="step1" class="step active">
        <p>আপনার ফোন নাম্বার দিন</p>
        <div class="phone-container">
            <span class="prefix">+880</span>
            <input type="text" id="phone" placeholder="১০ ডিজিট লিখুন" maxlength="10">
        </div>
        <div id="recaptcha-container"></div> <button class="btn" id="send-otp-btn" onclick="sendOTP()">OTP পাঠান</button>
    </div>

    <div id="step2" class="step">
        <p>আপনার ফোনে পাঠানো OTP দিন</p>
        <input type="text" id="otpInput" placeholder="OTP লিখুন" maxlength="6" style="border: 1px solid #ccc; border-radius: 8px; text-align: center;">
        <button class="btn" onclick="verifyOTP()">OTP যাচাই করুন</button>
    </div>

    <div id="step3" class="step">
        <p>নতুন পাসওয়ার্ড সেট করুন</p>
        <input type="password" id="newPass" placeholder="নতুন পাসওয়ার্ড (৬ ডিজিট)" maxlength="6" style="border: 1px solid #ccc; border-radius: 8px; margin-bottom: 10px;">
        <button class="btn" onclick="updatePassword()">পাসওয়ার্ড আপডেট করুন</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD_7v6rBHjVLHVK5OGiJpkgBzAuaJO8vn0",
        authDomain: "boi-baz-v2.firebaseapp.com",
        projectId: "boi-baz-v2",
        storageBucket: "boi-baz-v2.firebasestorage.app",
        messagingSenderId: "573343324145",
        appId: "1:573343324145:web:42899dd75501af36985650"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let confirmationResult;
    let userDocId = "";
    let userPhone = "";
    let userName = "";

    // reCAPTCHA সেটআপ
    window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
        'size': 'invisible'
    });

    window.sendOTP = async function() {
        const phoneInput = document.getElementById('phone').value.trim();
        userPhone = "+880" + phoneInput;

        // ডাটাবেজে ইউজার আছে কি না চেক করা
        const q = query(collection(db, "users"), where("phone", "==", userPhone));
        const snap = await getDocs(q);

        if (snap.empty) {
            alert("এই নাম্বারে কোনো অ্যাকাউন্ট পাওয়া যায়নি!");
            return;
        }

        userDocId = snap.docs[0].id;
        userName = snap.docs[0].data().name;

        const appVerifier = window.recaptchaVerifier;

        signInWithPhoneNumber(auth, userPhone, appVerifier)
            .then((result) => {
                confirmationResult = result;
                alert("আপনার ফোনে OTP পাঠানো হয়েছে।");
                showStep(2);
            }).catch((error) => {
                alert("OTP পাঠাতে সমস্যা হয়েছে। ১০টির লিমিট শেষ হতে পারে।");
            });
    }

    window.verifyOTP = function() {
        const code = document.getElementById('otpInput').value;
        confirmationResult.confirm(code).then(() => {
            showStep(3);
        }).catch(() => {
            alert("ভুল OTP! আবার চেষ্টা করুন।");
        });
    }

    window.updatePassword = async function() {
        const newPass = document.getElementById('newPass').value;
        if (newPass.length !== 6) {
            alert("পাসওয়ার্ড ঠিক ৬ ডিজিটের হতে হবে।");
            return;
        }

        try {
            const userRef = doc(db, "users", userDocId);
            await updateDoc(userRef, { pass: newPass });
            
            localStorage.setItem('userId', userDocId);
            localStorage.setItem('userName', userName);
            localStorage.setItem('userPhone', userPhone);

            alert("পাসওয়ার্ড সফলভাবে পরিবর্তন হয়েছে!");
            window.location.href = "index.html";
        } catch (e) {
            alert("পাসওয়ার্ড আপডেট করতে সমস্যা হয়েছে।");
        }
    }

    function showStep(s) {
        document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
        document.getElementById('step' + s).classList.add('active');
    }
</script>
</body>
</html>
